#!/bin/bash
# Generated by Chef - do not edit this file

# Setup error detection and handling
set -o nounset
set -o errexit
function error_handler()
{
    echo "********************************************************"
    echo "* BACKUP FAILED - SEE COMMAND OUTPUTS ABOVE            *"
    echo "********************************************************"
}
trap 'error_handler' ERR

<% if node['duplicity']['backup_mysql'] %>
echo "Creating database dump"

# Create temp dir that only we can see
MYSQLTMPDIR="$(mktemp -d)"

DBS="$(mysql --defaults-file=/etc/duplicity/mysql.cnf -h localhost -Bse 'show databases')"
for db in $DBS
do
  if [ "$db" != "information_schema" ]; then
    echo " * Dumping mySQL database $db"
    mysqldump --defaults-file=/etc/duplicity/mysql.cnf -h localhost <%=node['duplicity']['mysql']['innodb_only'] ? '--single-transaction' : '' %> $db | gzip -9 > $MYSQLTMPDIR/mysql-$db.sql.gz
  fi
done

echo "Backing up database dump"
$DUPLICITY --full-if-older-than $FULLDAYS $S3OPTIONS $EXTRADUPLICITYOPTIONS --name mysql_backup --allow-source-mismatch $MYSQLTMPDIR $S3MYSQLLOCATION

rm -rf $MYSQLTMPDIR

<% end %>

### File backup ###
echo "Backing up files"
duplicity --full-if-older-than $FULLDAYS $S3OPTIONS $EXTRADUPLICITYOPTIONS --name file_backup --include-globbing-filelist --exclude '**' / $S3FILESYSLOCATION


### Old backup cleanup ###
echo "Cleaning old full backups"
duplicity remove-all-but-n-full $MAXFULL --force $S3OPTIONS $EXTRADUPLICITYOPTIONS $S3FILESYSLOCATION

echo "Cleaning old full database backups"
duplicity remove-all-but-n-full $MAXFULL --force $S3OPTIONS $EXTRADUPLICITYOPTIONS $S3MYSQLLOCATION